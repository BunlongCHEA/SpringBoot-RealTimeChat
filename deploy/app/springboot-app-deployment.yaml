# Deployment for Spring Boot application
apiVersion: apps/v1
kind: Deployment
metadata:
  name: springboot-app-deployment
  namespace: production
  labels:
    app: springboot-app
    version: "1.0.0"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: springboot-app
  template:
    metadata:
      labels:
        app: springboot-app
        tier: backend
        database-client: "allowed"  # For PostgreSQL access
    spec:
      containers:
      - name: springboot-app
        image: registry.gitlab.com/bunlongchea/springboot-realtimechat:latest  # Replace with your actual image
        ports:
        - containerPort: 8080
          name: http
        env:
        # Inject ALL ConfigMap values as environment variables
        - name: SPRING_DATASOURCE_URL
          valueFrom:
            configMapKeyRef:
              name: springboot-app-config
              key: SPRING_DATASOURCE_URL
        - name: SPRING_JPA_HIBERNATE_DDL_AUTO
          valueFrom:
            configMapKeyRef:
              name: springboot-app-config
              key: SPRING_JPA_HIBERNATE_DDL_AUTO
        - name: SPRING_JPA_SHOW_SQL
          valueFrom:
            configMapKeyRef:
              name: springboot-app-config
              key: SPRING_JPA_SHOW_SQL
        - name: JWT_EXPIRATION
          valueFrom:
            configMapKeyRef:
              name: springboot-app-config
              key: JWT_EXPIRATION
        - name: JWT_REFRESH_EXPIRATION
          valueFrom:
            configMapKeyRef:
              name: springboot-app-config
              key: JWT_REFRESH_EXPIRATION
        # Secret values
        - name: SPRING_DATASOURCE_USERNAME
          valueFrom:
            secretKeyRef:
              name: springboot-app-secret
              key: SPRING_DATASOURCE_USERNAME
        - name: SPRING_DATASOURCE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: springboot-app-secret
              key: SPRING_DATASOURCE_PASSWORD
        - name: SPRING_DATA_MONGODB_URI
          valueFrom:
            secretKeyRef:
              name: springboot-app-secret
              key: SPRING_DATA_MONGODB_URI
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: springboot-app-secret
              key: JWT_SECRET
        - name: SPRING_PROFILES_ACTIVE
          value: "production"
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        startupProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 30
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000

---
# Secret for Spring Boot application
apiVersion: v1
kind: Secret
metadata:
  name: springboot-app-secret
  namespace: production
type: Opaque
data:
  # Database connection secrets (base64 encoded)
  # postgres
  SPRING_DATASOURCE_USERNAME: cG9zdGdyZXM=
  # strongpassword123
  SPRING_DATASOURCE_PASSWORD: c3Ryb25ncGFzc3dvcmQxMjM=
  # realtimechat
  # DB_NAME: cmVhbHRpbWVjaGF0
  # jwt-secret
  JWT_SECRET: 1de549fe4ebc93bf42b98b24fc5f617469e74d475a655d3df35fe2dce9268133e023c6471a99a72dc420e04389a4e6f8
  # mongodb://admin:07QmRa1RYrP3oq4@mongodb-service.production.svc.cluster.local:27017/MongoDB?authSource=admin
  SPRING_DATA_MONGODB_URI: bW9uZ29kYjovL2FkbWluOjA3UW1SYTFSWXJQM29xNEBtb25nb2RiLXNlcnZpY2UucHJvZHVjdGlvbi5zdmMuY2x1c3Rlci5sb2NhbDoyNzAxNy9Nb25nb0RCP2F1dGhTb3VyY2U9YWRtaW4=

---
# ConfigMap for Spring Boot application configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: springboot-app-config
  namespace: production
data:
  # Just environment-specific values
  SPRING_DATASOURCE_URL: "jdbc:postgresql://postgres-service:5432/realtimechat"
  SPRING_DATASOURCE_DRIVER_CLASS_NAME: "org.postgresql.Driver"
  SPRING_JPA_HIBERNATE_DDL_AUTO: "update"
  SPRING_JPA_SHOW_SQL: "false"
  JWT_EXPIRATION: "86400"
  JWT_REFRESH_EXPIRATION: "604800"

---
# Service for Spring Boot application
apiVersion: v1
kind: Service
metadata:
  name: springboot-app-service
  namespace: production
  labels:
    app: springboot-app
    service-type: backend-api
spec:
  type: ClusterIP
  ports:
  - port: 80
    targetPort: 8080
    protocol: TCP
    name: http
  selector:
    app: springboot-app

---
# Ingress for external access via Cloudflare
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: springboot-app-ingress
  namespace: production
  annotations:
    # Use NGINX Ingress Controller
    kubernetes.io/ingress.class: "nginx"

    # Cloudflare Basic proxy settings
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "600"

    # CORS headers for Swagger and API
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "https://chatspringboot.bunlong.site,https://www.chatspringboot.bunlong.site,https://chatnextjs.bunlong.site,https://www.chatnextjs.bunlong.site"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS, PATCH"

    nginx.ingress.kubernetes.io/ssl-redirect: "false"  # Cloudflare handles HTTPS
    nginx.ingress.kubernetes.io/force-ssl-redirect: "false"

    # Use standard annotations instead of snippets
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
    nginx.ingress.kubernetes.io/upstream-vhost: "chatspringboot.bunlong.site"

    # Add real IP forwarding (safer than snippets)
    nginx.ingress.kubernetes.io/use-forwarded-headers: "true"
    nginx.ingress.kubernetes.io/enable-real-ip: "true"
spec:
  rules:
  - host: chatspringboot.bunlong.site
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: springboot-app-service
            port:
              number: 80

#---
# NetworkPolicy for Spring Boot application security
#apiVersion: networking.k8s.io/v1
#kind: NetworkPolicy
#metadata:
#  name: springboot-app-network-policy
#  namespace: production
#spec:
#  podSelector:
#    matchLabels:
#      app: springboot-app
#  policyTypes:
#  - Ingress
#  - Egress
#  ingress:
#  # Allow traffic from ingress controller
#  - from: []
#    ports:
#    - protocol: TCP
#      port: 8080
#  egress:
#  # Allow connection to PostgreSQL in default namespace
#  - to:
#    - namespaceSelector:
#        matchLabels:
#          name: production
#    - podSelector:
#        matchLabels:
#          app: postgres
#    ports:
#    - protocol: TCP
#      port: 5432
#  # Allow DNS resolution
#  - to: []
#    ports:
#    - protocol: UDP
#      port: 53
#    - protocol: TCP
#      port: 53
#  # Allow HTTPS outbound (for external APIs)
#  - to: []
#    ports:
#    - protocol: TCP
#      port: 443
#    - protocol: TCP
#      port: 80

#---
# HorizontalPodAutoscaler for auto-scaling
#apiVersion: autoscaling/v2
#kind: HorizontalPodAutoscaler
#metadata:
#  name: springboot-app-hpa
#  namespace: production
#spec:
#  scaleTargetRef:
#    apiVersion: apps/v1
#    kind: Deployment
#    name: springboot-app-deployment
#  minReplicas: 3
#  maxReplicas: 10
#  metrics:
#  - type: Resource
#    resource:
#      name: cpu
#      target:
#        type: Utilization
#        averageUtilization: 70
#  - type: Resource
#    resource:
#      name: memory
#      target:
#        type: Utilization
#        averageUtilization: 80