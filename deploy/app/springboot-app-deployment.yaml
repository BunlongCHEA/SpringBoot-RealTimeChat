# Deployment for Spring Boot application
apiVersion: apps/v1
kind: Deployment
metadata:
  name: springboot-app-deployment
  namespace: production
  labels:
    app: springboot-app
    version: "1.0.0"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: springboot-app
  template:
    metadata:
      labels:
        app: springboot-app
        tier: backend
        database-client: "allowed"  # For PostgreSQL access
    spec:
      containers:
      - name: springboot-app
        image: registry.gitlab.com/bunlongchea/springboot-realtimechat:latest  # Replace with your actual image
        ports:
        - containerPort: 8080
          name: http
        env:
        # Inject ALL ConfigMap values as environment variables
        - name: SPRING_DATASOURCE_URL
          valueFrom:
            configMapKeyRef:
              name: springboot-app-config
              key: SPRING_DATASOURCE_URL
        - name: SPRING_JPA_HIBERNATE_DDL_AUTO
          valueFrom:
            configMapKeyRef:
              name: springboot-app-config
              key: SPRING_JPA_HIBERNATE_DDL_AUTO
        - name: SPRING_JPA_SHOW_SQL
          valueFrom:
            configMapKeyRef:
              name: springboot-app-config
              key: SPRING_JPA_SHOW_SQL
        - name: JWT_EXPIRATION
          valueFrom:
            configMapKeyRef:
              name: springboot-app-config
              key: JWT_EXPIRATION
        - name: JWT_REFRESH_EXPIRATION
          valueFrom:
            configMapKeyRef:
              name: springboot-app-config
              key: JWT_REFRESH_EXPIRATION
        # Secret values
        - name: SPRING_DATASOURCE_USERNAME
          valueFrom:
            secretKeyRef:
              name: springboot-app-secret
              key: SPRING_DATASOURCE_USERNAME
        - name: SPRING_DATASOURCE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: springboot-app-secret
              key: SPRING_DATASOURCE_PASSWORD
        - name: SPRING_DATA_MONGODB_URI
          valueFrom:
            secretKeyRef:
              name: springboot-app-secret
              key: SPRING_DATA_MONGODB_URI
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: springboot-app-secret
              key: JWT_SECRET
        - name: FIREBASE.CREDENTIALS.ENCODED
          valueFrom:
            secretKeyRef:
              name: springboot-app-secret
              key: FIREBASE.CREDENTIALS.ENCODED
        - name: SPRING_PROFILES_ACTIVE
          value: "production"
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        startupProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 30
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000

---
# Secret for Spring Boot application
apiVersion: v1
kind: Secret
metadata:
  name: springboot-app-secret
  namespace: production
type: Opaque
data:
  # Database connection secrets (base64 encoded)
  # postgres
  SPRING_DATASOURCE_USERNAME: cG9zdGdyZXM=
  # strongpassword123
  SPRING_DATASOURCE_PASSWORD: c3Ryb25ncGFzc3dvcmQxMjM=
  # realtimechat
  # DB_NAME: cmVhbHRpbWVjaGF0
  # jwt-secret
  JWT_SECRET: 1de549fe4ebc93bf42b98b24fc5f617469e74d475a655d3df35fe2dce9268133e023c6471a99a72dc420e04389a4e6f8
  # mongodb://admin:07QmRa1RYrP3oq4@mongodb-service.production.svc.cluster.local:27017/MongoDB?authSource=admin
  SPRING_DATA_MONGODB_URI: bW9uZ29kYjovL2FkbWluOjA3UW1SYTFSWXJQM29xNEBtb25nb2RiLXNlcnZpY2UucHJvZHVjdGlvbi5zdmMuY2x1c3Rlci5sb2NhbDoyNzAxNy9Nb25nb0RCP2F1dGhTb3VyY2U9YWRtaW4=
  FIREBASE.CREDENTIALS.ENCODED: ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAiYnVubG9uZy0yMmY2NiIsCiAgInByaXZhdGVfa2V5X2lkIjogIjkzMjkzYzgxYWFiMjAyZjkwNGRiODUyOTIyZjA4MTllYjQ0ZGY0ZmYiLAogICJwcml2YXRlX2tleSI6ICItLS0tLUJFR0lOIFBSSVZBVEUgS0VZLS0tLS1cbk1JSUV2Z0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktnd2dnU2tBZ0VBQW9JQkFRRGl2Tks0SkdKdzVCWmlcblcxNHVEa3FyQlRxMjNuKzVMdHAzVzByZ3lGUk54bXhpb3d0cGl1VkdvTytzVVZJSWhQL1MzaDV0Q25tdmJlaVRcbmx4WmRMVHkyRHQyQU80aXZSMUF1L1dIbFJTK0ozYlRmRVBDenE5UFZka2FHWXk3M0xmMkc5bnkxZjhBazdtOVpcbmYwSURIY0ExdnE0UG1xQk9GbUFldG5ZUXRtRURrV1FHM3ZkVXgzaGZweS9uSWNYOEVIWndKdHpieTB2R1A3VzVcbjBoNnNGb21GMDZ3TUhXM25mamhyVjhTY0Z1VlRHT3dXVXI1akMvYkhFdFdpcXdCY0JKR0w5MkNyQVQyOE9jRmtcbm53VW96L3BORlo0RXRMdHZYSVRrV1RQTE5BUGs1VWJ6Nkg5ekxSZXpUUytvQmJQclIrV1FjTzRSNmNkNWR0MFpcbmNaSGRZL1JQQWdNQkFBRUNnZ0VBY1JBSFk1dUJHeG9ocjFvd1ZIYjc5TnZlczJHdi92L0dJTTU5UUNtbElFTlpcbnVMWGs4dlEzOEVoQU80VXhpdDRIVTNjL1pOQmNiWVk0KzUvVG54TDN1ekVlY3RzOUJXcGlLWXhnVEp0N1lSd1ZcbkhVYXRRR3JtYndOVGw1L053NlJEVUJHSmpsZnQwSHkxT2NPamZ6cE9wbjQyL2NEMVB2c1pZemRKR0h4WlZCVXpcbldjRFg4aUFiRFdDK3pTVXErd3RsZllEZU4zM1VwM2hRMFlvSGRRemFpRmFOSVNGSlBGWmt6aE55TjZMbUtjUTlcblpwMG5iRWppaThFL3FURllvYitGSTZDYUttdFJDbVIyNCtIc1hCa2FRNmlQTkMzQ3RNYzVjR3BwWjJKVmtlbGNcbmhZeGhmdHRRbnY3OUsvckVXb3pWUG5EbzlNTzl6VmpIUm9DSlBXc3FRUUtCZ1FEOXhDREt2TXJHQlA5R0d2RVVcbjhCK2JQdVJ3ckc1MkRSTG81MGdEQUh3TGdSQTV5dUt4YUgrT3JuL0lGS2h1UU5wQjQwL2ZMVittYnNKYVRYMy9cbmNLUUJVZ1pPWmxYY2pUVHVldFFoeitZN2dhL0tiRjY2bDA1OW8rQWRZRmVMcXhMUDdZK0htZzNST1FaUXRpZWlcbmlWTlc2MnEvOUZvcTNDT1JkZWlyVE1IbDh3S0JnUURrdThrQW85UzhocTZXQnRFUERDUTljd0xwRklKSExKSXhcbjlGdXB2eDlLSnJpZjRUdm9rZ3lBOStBUmY2N254bVcydGVmQWZhMHpTdy9JQlFQZy96M3FvY3o5NEp1ZmJtVmlcbnUvbkRGckZMUW5JR1FiQ0JTMGxqb0xPSzkyV2NtbGIxUDA1U2NPNEZxUmZXUmZnQ2pSL2MxRHBUSzYvdHN1VDJcbmluZ0xmaHlETlFLQmdIcFgwQ2R1RmFTYVRDZ1VYUjVuRmhYV29IUGg3ZTlrSmpXN0szQ25EeWJNdG5IbWFweDFcbmNPbnRIeFhyUDdqSDgzSElrWDFiZHIzYXNFQ3hFNG5QV0lKNmRTZmZGbzRhVmVhVHVTb0QvVSs3R25GUkJlcVhcbmYvUDZ5ZFhmMk5VeFNRU04xNkRjbU1UQjVWV01QRmVVTldXMlllVGhmWWNrVXRHU012WkRMMGdaQW9HQkFMZjJcblEvb015ZHQ2b3MyczI5VXpXYTVHWXUvYys4Nk1qV1E1K01MMElSRTlSVDNwSTRxd2MvZ0I1Q2VPdnJoUWU1dlFcbmYzejBWeW1xMUIxMTB5SFJoeFcvWGlSTjBqd095T0g0OXk2dGdKaGI3Mk1TMEFlYzZvQ0RUZ09WYUJia2xzMldcblJjTE9hdEVJcDFCQlkrK0JXei83UEpHSjBHdm5kbmpHOHplakRRR0ZBb0dCQUxLaDE2SzNtMHZnaVBKdVZXMzNcbmVTYWpRZjJRR3VzMU1PNFVhQ1Y1RDBjN3owemY4MTFVWXJQS1k3d0dmdElIbkFReWl2QXFBZ0NCK2JlSUF1dUtcbk5yMWZNNkdOazVLYUcxcDF1d3c4RCswbCt2bzFvNTM3VUF4WFFzN2JybkhPSUVjb1lsUVZkOHBtRUdaVXlsSWVcbk1wR0pxaTFpcnk3UkpXSzVybHNEVkVVUVxuLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLVxuIiwKICAiY2xpZW50X2VtYWlsIjogImZpcmViYXNlLWFkbWluc2RrLWZic3ZjQGJ1bmxvbmctMjJmNjYuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLAogICJjbGllbnRfaWQiOiAiMTA3MTY4NTY2MDg5MjYzNjU4Nzg5IiwKICAiYXV0aF91cmkiOiAiaHR0cHM6Ly9hY2NvdW50cy5nb29nbGUuY29tL28vb2F1dGgyL2F1dGgiLAogICJ0b2tlbl91cmkiOiAiaHR0cHM6Ly9vYXV0aDIuZ29vZ2xlYXBpcy5jb20vdG9rZW4iLAogICJhdXRoX3Byb3ZpZGVyX3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vb2F1dGgyL3YxL2NlcnRzIiwKICAiY2xpZW50X3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vcm9ib3QvdjEvbWV0YWRhdGEveDUwOS9maXJlYmFzZS1hZG1pbnNkay1mYnN2YyU0MGJ1bmxvbmctMjJmNjYuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLAogICJ1bml2ZXJzZV9kb21haW4iOiAiZ29vZ2xlYXBpcy5jb20iCn0K

---
# ConfigMap for Spring Boot application configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: springboot-app-config
  namespace: production
data:
  # Just environment-specific values
  SPRING_DATASOURCE_URL: "jdbc:postgresql://postgres-service:5432/realtimechat"
  SPRING_DATASOURCE_DRIVER_CLASS_NAME: "org.postgresql.Driver"
  SPRING_JPA_HIBERNATE_DDL_AUTO: "update"
  SPRING_JPA_SHOW_SQL: "false"
  JWT_EXPIRATION: "86400"
  JWT_REFRESH_EXPIRATION: "604800"

---
# Service for Spring Boot application
apiVersion: v1
kind: Service
metadata:
  name: springboot-app-service
  namespace: production
  labels:
    app: springboot-app
    service-type: backend-api
spec:
  type: ClusterIP
  ports:
  - port: 80
    targetPort: 8080
    protocol: TCP
    name: http
  selector:
    app: springboot-app

---
# Ingress for external access via Cloudflare
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: springboot-app-ingress
  namespace: production
  annotations:
    # Use NGINX Ingress Controller
    kubernetes.io/ingress.class: "nginx"

    # Cloudflare Basic proxy settings
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "600"

    # CORS headers for Swagger and API
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "https://chatspringboot.bunlong.site,https://www.chatspringboot.bunlong.site,https://chatnextjs.bunlong.site,https://www.chatnextjs.bunlong.site"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS, PATCH"

    nginx.ingress.kubernetes.io/ssl-redirect: "false"  # Cloudflare handles HTTPS
    nginx.ingress.kubernetes.io/force-ssl-redirect: "false"

    # Use standard annotations instead of snippets
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
    nginx.ingress.kubernetes.io/upstream-vhost: "chatspringboot.bunlong.site"

    # Add real IP forwarding (safer than snippets)
    nginx.ingress.kubernetes.io/use-forwarded-headers: "true"
    nginx.ingress.kubernetes.io/enable-real-ip: "true"
spec:
  rules:
  - host: chatspringboot.bunlong.site
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: springboot-app-service
            port:
              number: 80

#---
# NetworkPolicy for Spring Boot application security
#apiVersion: networking.k8s.io/v1
#kind: NetworkPolicy
#metadata:
#  name: springboot-app-network-policy
#  namespace: production
#spec:
#  podSelector:
#    matchLabels:
#      app: springboot-app
#  policyTypes:
#  - Ingress
#  - Egress
#  ingress:
#  # Allow traffic from ingress controller
#  - from: []
#    ports:
#    - protocol: TCP
#      port: 8080
#  egress:
#  # Allow connection to PostgreSQL in default namespace
#  - to:
#    - namespaceSelector:
#        matchLabels:
#          name: production
#    - podSelector:
#        matchLabels:
#          app: postgres
#    ports:
#    - protocol: TCP
#      port: 5432
#  # Allow DNS resolution
#  - to: []
#    ports:
#    - protocol: UDP
#      port: 53
#    - protocol: TCP
#      port: 53
#  # Allow HTTPS outbound (for external APIs)
#  - to: []
#    ports:
#    - protocol: TCP
#      port: 443
#    - protocol: TCP
#      port: 80

#---
# HorizontalPodAutoscaler for auto-scaling
#apiVersion: autoscaling/v2
#kind: HorizontalPodAutoscaler
#metadata:
#  name: springboot-app-hpa
#  namespace: production
#spec:
#  scaleTargetRef:
#    apiVersion: apps/v1
#    kind: Deployment
#    name: springboot-app-deployment
#  minReplicas: 3
#  maxReplicas: 10
#  metrics:
#  - type: Resource
#    resource:
#      name: cpu
#      target:
#        type: Utilization
#        averageUtilization: 70
#  - type: Resource
#    resource:
#      name: memory
#      target:
#        type: Utilization
#        averageUtilization: 80